name: Django-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Install dependencies
        run: |
          # обновление pip
          python -m pip install --upgrade pip 
          # установка flake8 и его плагинов
          pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
          # установка зависимостей
          pip install -r requirements.txt

      - name: Test with flake8 and django tests
        run: |
          # запуск проверки проекта по flake8
          python -m flake8
          # перейти в папку, содержащую manage.py — 
          #<корневая_папка_infra_actions>/<папка_проекта>/manage.py
          cd infra_project/
          # запустить написанные разработчиком тесты
          python manage.py test

  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1
      - name: Login to Docker
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: zaqer/infra_actions

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: 84.201.164.144
        username: zaqer
        key: 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
        #passphrase: ${{ secrets.PASSPHRASE }} # Если ваш ssh-ключ защищён фразой-паролем
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull zaqer/infra_actions
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 zaqer/infra_actions

